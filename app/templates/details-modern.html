<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article Enhancement Studio - Basement Cowboy</title>
    
    <!-- Primary Styles -->
    <link href="{{ url_for('static', filename='styles-improved.css') }}" rel="stylesheet">
    <!-- Bootstrap for compatibility -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        if (window.axios) axios.defaults.withCredentials = true;
    </script>
    
    <style>
        /* Component-specific styles */
        .enhancement-studio {
            background: linear-gradient(135deg, var(--color-primary-600) 0%, var(--color-primary-700) 100%);
            color: var(--color-white);
            padding: var(--space-8) 0;
            margin-bottom: var(--space-8);
        }
        
        .enhancement-studio h1 {
            color: var(--color-white);
            margin-bottom: var(--space-6);
            font-weight: var(--font-weight-bold);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            text-align: center;
        }
        
        .stat-number {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-white);
            margin-bottom: var(--space-2);
        }
        
        .stat-label {
            font-size: var(--font-size-sm);
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* API Cost Tracker */
        .api-costs {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
        }
        
        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2) 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .cost-item:last-child {
            border-bottom: none;
        }
        
        .cost-label {
            font-size: var(--font-size-sm);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .cost-value {
            font-weight: var(--font-weight-semibold);
            color: var(--color-white);
        }
        
        /* Article grid */
        .article-enhancement-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-6);
        }
        
        @media (max-width: 1200px) {
            .article-enhancement-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .article-enhancement-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .article-enhancement-card {
            background: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
            transition: var(--transition-base);
        }
        
        .article-enhancement-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .ranking-badge {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            background: var(--color-success-500);
            color: var(--color-white);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            z-index: 10;
        }
        
        .article-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: var(--radius-md);
            margin-bottom: var(--space-4);
        }
        
        .article-title {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-3);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .enhancement-controls {
            margin-top: var(--space-4);
        }
        
        .enhancement-section {
            margin-bottom: var(--space-4);
            padding: var(--space-4);
            background: var(--color-gray-50);
            border-radius: var(--radius-md);
        }
        
        .enhancement-label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-2);
        }
        
        /* Quick Actions Panel */
        .quick-actions-panel {
            background: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
        }
        
        .quick-actions-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-4);
        }
        
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-3);
        }
    </style>
</head>
<body class="modern-layout">
    <!-- Header Section -->
    <div class="enhancement-studio">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1><i class="fas fa-magic me-3"></i>Article Enhancement Studio</h1>
                    <p class="mb-0">Review, enhance, and publish your curated news articles</p>
                </div>
                <div class="d-flex gap-3">
                    <a href="{{ url_for('review') }}" class="btn btn-outline-light">
                        <i class="fas fa-arrow-left me-2"></i>Back to Review
                    </a>
                    <a href="#" class="btn btn-outline-light" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </a>
                </div>
            </div>
            
            <!-- Smart Ranking Badge -->
            <div class="ranking-info mb-4">
                <span class="badge bg-success me-2">
                    <i class="fas fa-brain me-1"></i>Smart Ranking
                </span>
                <span class="text-light">Articles sorted by AI quality score</span>
                {% if selected_articles %}
                <span class="badge bg-warning ms-3">{{ selected_articles|length }}</span>
                <span class="badge bg-info ms-1">{{ good_score_count }}</span>
                <span class="badge bg-secondary ms-1">{{ ok_score_count }}</span>
                {% endif %}
            </div>
            
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">{{ articles|length }}</div>
                    <div class="stat-label">Total Articles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ selected_articles|length if selected_articles else 0 }}</div>
                    <div class="stat-label">Selected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="enhanced-count">0</div>
                    <div class="stat-label">Enhanced</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="ready-count">0</div>
                    <div class="stat-label">Ready to Publish</div>
                </div>
            </div>
            
            <!-- API Cost Tracker -->
            <div class="api-costs">
                <h6 class="text-white mb-3"><i class="fas fa-dollar-sign me-2"></i>API Usage Tracking</h6>
                <div class="cost-item">
                    <span class="cost-label">Summarization Calls</span>
                    <span class="cost-value" id="summary-cost">$0.00</span>
                </div>
                <div class="cost-item">
                    <span class="cost-label">Image Generation</span>
                    <span class="cost-value" id="image-cost">$0.00</span>
                </div>
                <div class="cost-item">
                    <span class="cost-label">Auto-Categorization</span>
                    <span class="cost-value" id="category-cost">$0.00</span>
                </div>
                <div class="cost-item">
                    <span class="cost-label"><strong>Total Session</strong></span>
                    <span class="cost-value" id="total-cost"><strong>$0.00</strong></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Quick Actions Panel -->
        <div class="quick-actions-panel">
            <h5 class="quick-actions-title">
                <i class="fas fa-bolt me-2"></i>Quick Actions
                <span class="badge bg-success ms-2" id="publish-ready-indicator">Ready</span>
            </h5>
            <div class="quick-actions-grid">
                <button class="btn btn-primary" onclick="selectAllToPublish()">
                    <i class="fas fa-check-double me-2"></i>Select All to Publish
                </button>
                <button class="btn btn-info" onclick="autoCategorizeThem()">
                    <i class="fas fa-tags me-2"></i>Auto-Categorize All
                </button>
                <button class="btn btn-warning" onclick="publishArticles()">
                    <i class="fas fa-upload me-2"></i>Publish Selected
                </button>
            </div>
        </div>

        <!-- Category Section -->
        {% if categories_by_name %}
        <div class="mb-4">
            {% for category, articles in categories_by_name.items() %}
            <h4 class="mb-3 text-primary">{{ category }}</h4>
            <div class="article-enhancement-grid mb-5">
                {% for article in articles %}
                <div class="article-enhancement-card position-relative">
                    <span class="ranking-badge">#{{ loop.index }}</span>
                    
                    <img src="{{ article.photo if article.photo else url_for('static', filename='default.jpg') }}" 
                         alt="Article Image" class="article-image">
                    
                    <h6 class="article-title">{{ article.headline }}</h6>
                    
                    <div class="enhancement-controls">
                        <!-- Summary Enhancement -->
                        <div class="enhancement-section">
                            <label class="enhancement-label">Summary:</label>
                            <textarea name="summary-{{ loop.index0 }}" class="form-control mb-2" rows="3" 
                                      placeholder="AI-generated summary will appear here...">{{ article.summary if article.summary else '' }}</textarea>
                            <button type="button" class="btn btn-sm btn-primary" 
                                    onclick="enhanceSummary({{ loop.index0 }}, '{{ article.headline|e }}', '{{ article.text|e }}')">
                                <i class="fas fa-magic me-1"></i>Enhance Summary
                            </button>
                        </div>
                        
                        <!-- Image Enhancement -->
                        <div class="enhancement-section">
                            <label class="enhancement-label">Image:</label>
                            <input type="text" name="image-{{ loop.index0 }}" class="form-control mb-2" 
                                   value="{{ article.photo if article.photo else '' }}" placeholder="Image URL">
                            <button type="button" class="btn btn-sm btn-success" 
                                    onclick="createAIImage({{ loop.index0 }}, '{{ article.headline|e }}')">
                                <i class="fas fa-image me-1"></i>Create AI Image
                            </button>
                        </div>
                        
                        <!-- Category Enhancement -->
                        <div class="enhancement-section">
                            <label class="enhancement-label">Category:</label>
                            <select name="category-{{ loop.index0 }}" class="form-select mb-2">
                                <option value="">Select Category</option>
                                <option value="Technology" {{ 'selected' if article.category == 'Technology' else '' }}>Technology</option>
                                <option value="Business" {{ 'selected' if article.category == 'Business' else '' }}>Business</option>
                                <option value="Health" {{ 'selected' if article.category == 'Health' else '' }}>Health</option>
                                <option value="Politics" {{ 'selected' if article.category == 'Politics' else '' }}>Politics</option>
                                <option value="Sports" {{ 'selected' if article.category == 'Sports' else '' }}>Sports</option>
                                <option value="Entertainment" {{ 'selected' if article.category == 'Entertainment' else '' }}>Entertainment</option>
                                <option value="Science" {{ 'selected' if article.category == 'Science' else '' }}>Science</option>
                                <option value="World" {{ 'selected' if article.category == 'World' else '' }}>World</option>
                            </select>
                            <button type="button" class="btn btn-sm btn-info" 
                                    onclick="aiCategorize({{ loop.index0 }}, '{{ article.headline|e }}', '{{ article.text|e }}')">
                                <i class="fas fa-robot me-1"></i>Auto-Categorize
                            </button>
                        </div>
                        
                        <!-- Publish Checkbox -->
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" name="publish-{{ loop.index0 }}" 
                                   id="publish-{{ loop.index0 }}" onchange="updatePublishCount()">
                            <label class="form-check-label" for="publish-{{ loop.index0 }}">
                                <strong>Ready to Publish</strong>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Hidden fields for article data -->
                    <input type="hidden" name="headline-{{ loop.index0 }}" value="{{ article.headline }}">
                    <input type="hidden" name="text-{{ loop.index0 }}" value="{{ article.text }}">
                    <input type="hidden" name="link-{{ loop.index0 }}" value="{{ article.link }}">
                    <input type="hidden" name="date-{{ loop.index0 }}" value="{{ article.date }}">
                    <input type="hidden" name="source-{{ loop.index0 }}" value="{{ article.source }}">
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Uncategorized Articles -->
        <h4 class="mb-3 text-secondary">Uncategorized</h4>
        <div class="article-enhancement-grid">
            {% for article in selected_articles %}
            <div class="article-enhancement-card position-relative">
                <span class="ranking-badge">#{{ loop.index }}</span>
                
                <img src="{{ article.photo if article.photo else url_for('static', filename='default.jpg') }}" 
                     alt="Article Image" class="article-image">
                
                <h6 class="article-title">{{ article.headline }}</h6>
                
                <div class="enhancement-controls">
                    <!-- Summary Enhancement -->
                    <div class="enhancement-section">
                        <label class="enhancement-label">Summary:</label>
                        <textarea name="summary-{{ loop.index0 }}" class="form-control mb-2" rows="3" 
                                  placeholder="AI-generated summary will appear here...">{{ article.summary if article.summary else '' }}</textarea>
                        <button type="button" class="btn btn-sm btn-primary" 
                                onclick="enhanceSummary({{ loop.index0 }}, '{{ article.headline|e }}', '{{ article.text|e }}')">
                            <i class="fas fa-magic me-1"></i>Enhance Summary
                        </button>
                    </div>
                    
                    <!-- Image Enhancement -->
                    <div class="enhancement-section">
                        <label class="enhancement-label">Image:</label>
                        <input type="text" name="image-{{ loop.index0 }}" class="form-control mb-2" 
                               value="{{ article.photo if article.photo else '' }}" placeholder="Image URL">
                        <button type="button" class="btn btn-sm btn-success" 
                                onclick="createAIImage({{ loop.index0 }}, '{{ article.headline|e }}')">
                            <i class="fas fa-image me-1"></i>Create AI Image
                        </button>
                    </div>
                    
                    <!-- Category Enhancement -->
                    <div class="enhancement-section">
                        <label class="enhancement-label">Category:</label>
                        <select name="category-{{ loop.index0 }}" class="form-select mb-2">
                            <option value="">Select Category</option>
                            <option value="Technology" {{ 'selected' if article.category == 'Technology' else '' }}>Technology</option>
                            <option value="Business" {{ 'selected' if article.category == 'Business' else '' }}>Business</option>
                            <option value="Health" {{ 'selected' if article.category == 'Health' else '' }}>Health</option>
                            <option value="Politics" {{ 'selected' if article.category == 'Politics' else '' }}>Politics</option>
                            <option value="Sports" {{ 'selected' if article.category == 'Sports' else '' }}>Sports</option>
                            <option value="Entertainment" {{ 'selected' if article.category == 'Entertainment' else '' }}>Entertainment</option>
                            <option value="Science" {{ 'selected' if article.category == 'Science' else '' }}>Science</option>
                            <option value="World" {{ 'selected' if article.category == 'World' else '' }}>World</option>
                        </select>
                        <button type="button" class="btn btn-sm btn-info" 
                                onclick="aiCategorize({{ loop.index0 }}, '{{ article.headline|e }}', '{{ article.text|e }}')">
                            <i class="fas fa-robot me-1"></i>Auto-Categorize
                        </button>
                    </div>
                    
                    <!-- Publish Checkbox -->
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" name="publish-{{ loop.index0 }}" 
                               id="publish-{{ loop.index0 }}" onchange="updatePublishCount()">
                        <label class="form-check-label" for="publish-{{ loop.index0 }}">
                            <strong>Ready to Publish</strong>
                        </label>
                    </div>
                </div>
                
                <!-- Hidden fields for article data -->
                <input type="hidden" name="headline-{{ loop.index0 }}" value="{{ article.headline }}">
                <input type="hidden" name="text-{{ loop.index0 }}" value="{{ article.text }}">
                <input type="hidden" name="link-{{ loop.index0 }}" value="{{ article.link }}">
                <input type="hidden" name="date-{{ loop.index0 }}" value="{{ article.date }}">
                <input type="hidden" name="source-{{ loop.index0 }}" value="{{ article.source }}">
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Form for article data -->
    <form id="article-details-form" style="display: none;">
        {% for article in selected_articles %}
        <input type="hidden" name="article_{{ loop.index0 }}" value="{{ article|tojson|e }}">
        {% endfor %}
    </form>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API Cost Tracking
        let apiCosts = {
            summarization: 0,
            imageGeneration: 0,
            categorization: 0
        };

        // Cost per operation (approximate OpenAI pricing)
        const costPerOperation = {
            summarization: 0.002, // per request
            imageGeneration: 0.04, // per image
            categorization: 0.001 // per request
        };

        function updateCostDisplay() {
            document.getElementById('summary-cost').textContent = '$' + apiCosts.summarization.toFixed(3);
            document.getElementById('image-cost').textContent = '$' + apiCosts.imageGeneration.toFixed(3);
            document.getElementById('category-cost').textContent = '$' + apiCosts.categorization.toFixed(3);
            
            const total = apiCosts.summarization + apiCosts.imageGeneration + apiCosts.categorization;
            document.getElementById('total-cost').textContent = '$' + total.toFixed(3);
        }

        function trackCost(operation) {
            apiCosts[operation] += costPerOperation[operation];
            updateCostDisplay();
        }

        // Update publish count
        function updatePublishCount() {
            const publishCheckboxes = document.querySelectorAll("input[name^='publish-']:checked");
            document.getElementById('ready-count').textContent = publishCheckboxes.length;
            
            const indicator = document.getElementById('publish-ready-indicator');
            if (publishCheckboxes.length > 0) {
                indicator.textContent = 'Ready (' + publishCheckboxes.length + ')';
                indicator.className = 'badge bg-success ms-2';
            } else {
                indicator.textContent = 'Ready';
                indicator.className = 'badge bg-secondary ms-2';
            }
        }

        // Select all articles for publishing
        function selectAllToPublish() {
            const publishCheckboxes = document.querySelectorAll("input[name^='publish-']");
            publishCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updatePublishCount();
        }

        // Auto-categorize all articles
        function autoCategorizeThem() {
            const articles = document.querySelectorAll('.article-enhancement-card');
            articles.forEach((card, index) => {
                const headlineElement = card.querySelector(`input[name='headline-${index}']`);
                const textElement = card.querySelector(`input[name='text-${index}']`);
                
                if (headlineElement && textElement) {
                    const headline = headlineElement.value;
                    const text = textElement.value;
                    setTimeout(() => aiCategorize(index, headline, text), index * 500); // Stagger requests
                }
            });
        }

        // Enhanced summary function with cost tracking
        async function enhanceSummary(articleIndex, headline, articleText) {
            const summaryTextarea = document.querySelector(`textarea[name='summary-${articleIndex}']`);
            const button = event.target;
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enhancing...';
            summaryTextarea.value = 'Generating AI summary...';
            
            try {
                const response = await axios.post('/ai_summarize', {
                    headline: headline,
                    text: articleText
                });
                
                if (response.data.success) {
                    summaryTextarea.value = response.data.summary;
                    trackCost('summarization'); // Track cost
                    updateEnhancedCount();
                } else {
                    summaryTextarea.value = 'Error generating summary: ' + response.data.error;
                }
            } catch (error) {
                console.error('Error enhancing summary:', error);
                summaryTextarea.value = 'Error generating summary. Please try again.';
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-magic me-1"></i>Enhance Summary';
            }
        }

        // Enhanced AI image creation with cost tracking
        async function createAIImage(articleIndex, headline) {
            const imageInput = document.querySelector(`input[name='image-${articleIndex}']`);
            const button = event.target;
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating...';
            imageInput.value = 'Generating AI image...';
            
            try {
                const response = await axios.post('/ai_generate_image', {
                    headline: headline
                });
                
                if (response.data.success) {
                    imageInput.value = response.data.image_url;
                    // Update the image display
                    const imageElement = document.querySelector(`.article-enhancement-card:nth-child(${articleIndex + 1}) .article-image`);
                    if (imageElement) {
                        imageElement.src = response.data.image_url;
                    }
                    trackCost('imageGeneration'); // Track cost
                    updateEnhancedCount();
                } else {
                    imageInput.value = 'Error generating image: ' + response.data.error;
                }
            } catch (error) {
                console.error('Error creating AI image:', error);
                imageInput.value = 'Error generating image. Please try again.';
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-image me-1"></i>Create AI Image';
            }
        }

        // Enhanced AI categorization with cost tracking
        async function aiCategorize(articleIndex, headline, articleText) {
            const categorySelect = document.querySelector(`select[name='category-${articleIndex}']`);
            const button = event.target;
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Analyzing...';
            
            try {
                const response = await axios.post('/ai_categorize', {
                    headline: headline,
                    text: articleText
                });
                
                if (response.data.success) {
                    categorySelect.value = response.data.category;
                    trackCost('categorization'); // Track cost
                    updateEnhancedCount();
                } else {
                    console.error('Error categorizing article:', response.data.error);
                }
            } catch (error) {
                console.error('Error categorizing article:', error);
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-robot me-1"></i>Auto-Categorize';
            }
        }

        function updateEnhancedCount() {
            // Count articles with summaries, images, or categories
            const summaries = document.querySelectorAll('textarea[name^="summary-"]:not([value=""]):not(:empty)');
            const images = document.querySelectorAll('input[name^="image-"]:not([value=""]):not([value*="default.jpg"])');
            const categories = document.querySelectorAll('select[name^="category-"] option:checked:not([value=""])');
            
            const enhanced = new Set();
            summaries.forEach((elem, i) => enhanced.add(i));
            images.forEach((elem, i) => enhanced.add(i));
            categories.forEach((elem, i) => enhanced.add(i));
            
            document.getElementById('enhanced-count').textContent = enhanced.size;
        }

        // Publish articles function
        async function publishArticles() {
            try {
                const publishCheckboxes = document.querySelectorAll("input[name^='publish-']:checked");
                if (publishCheckboxes.length === 0) {
                    alert("Please select at least one article for publishing by checking the 'Ready to Publish' checkbox.");
                    return;
                }

                console.log(`Publishing ${publishCheckboxes.length} selected articles...`);
                
                const formData = new FormData(document.getElementById("article-details-form"));
                
                // Add enhanced data from form
                publishCheckboxes.forEach((checkbox) => {
                    const index = checkbox.name.split('-')[1];
                    const summary = document.querySelector(`textarea[name='summary-${index}']`).value;
                    const image = document.querySelector(`input[name='image-${index}']`).value;
                    const category = document.querySelector(`select[name='category-${index}']`).value;
                    
                    formData.append(`enhanced_summary_${index}`, summary);
                    formData.append(`enhanced_image_${index}`, image);
                    formData.append(`enhanced_category_${index}`, category);
                    formData.append(`publish_${index}`, 'true');
                });
                
                const response = await axios.post("/publish_article", formData);

                if (response.data.success) {
                    alert(`Articles published successfully! Post ID: ${response.data.post_url}`);
                    console.log("Publish response:", response.data);
                    if (response.data.post_url) {
                        const redirect = confirm("Would you like to view the published post?");
                        if (redirect) {
                            window.open(response.data.post_url, '_blank');
                        }
                    }
                } else {
                    alert("Failed to publish articles: " + response.data.error);
                    console.error("Publish error:", response.data);
                }
            } catch (error) {
                console.error("Error publishing articles:", error);
                alert("Error publishing articles: " + error.message);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout? Any unsaved changes will be lost.')) {
                window.location.href = '/';
            }
        }

        // Initialize cost tracking on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateCostDisplay();
            updatePublishCount();
            updateEnhancedCount();
        });
    </script>
</body>
</html>